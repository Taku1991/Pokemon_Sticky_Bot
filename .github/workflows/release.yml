name: Build and Release

on:
  push:
    tags:
      - 'v*'  # Trigger auf alle Tags die mit v beginnen (z.B. v1.0.0)

jobs:
  build-and-release:
    runs-on: windows-latest
    
    steps:
    - name: Checkout Code
      uses: actions/checkout@v4
      
    - name: Setup Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
        
    - name: Install Dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install pyinstaller
        
    - name: Build with Minimal Build System
      run: |
        Write-Host "ğŸš€ Starte minimales Build-System..."
        python build.py
        
    - name: Verify Minimal Build Results
      run: |
        Write-Host "ğŸ” ÃœberprÃ¼fe minimale Build-Ergebnisse..."
        
        if (Test-Path "dist\StickyBot.exe") { 
          $size = (Get-Item "dist\StickyBot.exe").Length / 1MB
          Write-Host "âœ… StickyBot.exe: ($([math]::Round($size, 1)) MB)"
        } else {
          Write-Host "âŒ StickyBot.exe nicht gefunden!"
          exit 1
        }
        
        # PrÃ¼fe nur die essentiellen Dateien (keine .env fÃ¼r GUI-Setup!)
        $requiredFiles = @(
          "dist\StickyBot.exe",
          "dist\data\sticky_messages.json",
          "dist\data\bot_roles.json",
          "dist\README.md"
        )
        
        Write-Host "ğŸ“‹ PrÃ¼fe essentielle Dateien..."
        foreach ($file in $requiredFiles) {
          if (Test-Path $file) {
            Write-Host "âœ… $file"
          } else {
            Write-Host "âŒ $file FEHLT!"
            exit 1
          }
        }
        
        # PrÃ¼fe dass KEINE .env vorhanden ist (wichtig fÃ¼r GUI-Setup!)
        if (Test-Path "dist\.env") {
          Write-Host "âŒ .env gefunden - wÃ¼rde GUI-Setup verhindern!"
          exit 1
        } else {
          Write-Host "âœ… Keine .env â†’ GUI-Setup wird starten"
        }
        
        Write-Host "ğŸ“ Finale dist-Struktur:"
        Get-ChildItem "dist" -Recurse | Where-Object {$_.Name -notlike "*.dll" -and $_.Name -notlike "*.pyd"} | Select-Object Name, Length, FullName
        
    - name: Create Minimal Release Package
      run: |
        Write-Host "ğŸ“¦ Erstelle ultra-minimales Release-Paket..."
        
        # Release-Name mit Tag
        $releaseName = "StickyBot-${{ github.ref_name }}"
        mkdir $releaseName
        
        Write-Host "ğŸ“ Kopiere nur essentielle Dateien..."
        
        # 1. Hauptprogramm
        Copy-Item "dist\StickyBot.exe" "$releaseName\"
        Write-Host "âœ… StickyBot.exe kopiert"
        
        # 2. data-Ordner mit JSON-Dateien
        Copy-Item -Path "dist\data" -Destination "$releaseName\data" -Recurse
        Write-Host "âœ… data/ Ordner kopiert"
        
        # 3. README.md
        Copy-Item "dist\README.md" "$releaseName\"
        Write-Host "âœ… README.md kopiert"
        
        Write-Host "ğŸ“¦ Ultra-minimales Release Package erstellt:"
        Write-Host "â”œâ”€â”€ StickyBot.exe"
        Write-Host "â”œâ”€â”€ data/"
        Write-Host "â”‚   â”œâ”€â”€ sticky_messages.json"
        Write-Host "â”‚   â””â”€â”€ bot_roles.json"
        Write-Host "â””â”€â”€ README.md"
        Write-Host ""
        Write-Host "ğŸ’¡ Keine .env â†’ GUI-Setup startet automatisch beim ersten Start!"
        
        # Zeige finale Struktur
        Get-ChildItem $releaseName -Recurse | Select-Object Name, Length
        
    - name: Create Minimal ZIP Archive
      run: |
        $releaseName = "StickyBot-${{ github.ref_name }}"
        Compress-Archive -Path "$releaseName\*" -DestinationPath "$releaseName.zip"
        Write-Host "ğŸ“¦ Minimales ZIP erstellt: $releaseName.zip"
        $zipSize = (Get-Item "$releaseName.zip").Length / 1MB
        Write-Host "ğŸ“¦ ZIP-GrÃ¶ÃŸe: $([math]::Round($zipSize, 1)) MB"
        
    - name: Archive Minimal Release Files
      uses: actions/upload-artifact@v4
      with:
        name: StickyBot-minimal-release
        path: StickyBot-${{ github.ref_name }}/
        
    - name: Create Minimal Release
      id: create_release
      uses: softprops/action-gh-release@v1
      env:
        GITHUB_TOKEN: ${{ secrets.PAT_TOKEN }}
      with:
        tag_name: ${{ github.ref_name }}
        name: Sticky-Bot ${{ github.ref_name }}
        body: |
          ## ğŸ¤– Sticky-Bot ${{ github.ref_name }}
          
          ### ğŸ“¦ **Download**
          **StickyBot-${{ github.ref_name }}.zip** - Minimales Release-Paket
          
          ### ğŸš€ **Installation:**
          1. **ZIP entpacken**
          2. **`StickyBot.exe` starten** (Setup-Dialog erscheint automatisch)
          3. **Discord Bot Token eingeben**
          4. **Fertig!** ğŸ‰
          
          ### ğŸ“‚ **EnthÃ¤lt nur essentielle Dateien:**
          ```
          StickyBot-${{ github.ref_name }}/
          â”œâ”€â”€ StickyBot.exe              # Hauptprogramm mit GUI-Kontrollzentrum
          â”œâ”€â”€ data/                      # Bot-Daten
          â”‚   â”œâ”€â”€ sticky_messages.json   # Alle Sticky Messages
          â”‚   â””â”€â”€ bot_roles.json         # Bot Master & Editoren
          â””â”€â”€ README.md                  # VollstÃ¤ndige Deutsche Anleitung
          ```
          
          ### ğŸ”‘ **Discord Bot Token:**
          1. **https://discord.com/developers/applications** â†’ "New Application"
          2. **"Bot" Tab** â†’ "Add Bot" â†’ **Token kopieren**
          3. **"Message Content Intent"** aktivieren âœ…
          
          ### ğŸ¯ **Features:**
          - ğŸ® **Management-Kontrollzentrum** mit 3 Tabs fÃ¼r Bot-Kontrolle
          - ğŸ“Œ **Automatische Sticky Messages** mit PokÃ©mon-Bildern
          - ğŸ‘‘ **Server-isolierte Berechtigungen** (Bot Master & Editoren)
          - ğŸ¨ **SchÃ¶ne Embeds** mit anpassbaren Inhalten
          - â° **Intelligente VerzÃ¶gerungen** gegen Spam
          - ğŸ”§ **GUI-Setup** mit automatischer Token-Validierung
          - ğŸ  **Multi-Server Support** - verwalte mehrere Discord-Server
          - ğŸ›¡ï¸ **Sichere Authentifizierung** mit Challenge-Response System
          
          ### ğŸ”§ **Erste Schritte:**
          1. **Bot Token erstellen** (Discord Developer Portal)
          2. **StickyBot.exe starten** â†’ Setup-Dialog erscheint
          3. **Token eingeben** â†’ Validierung erfolgt automatisch
          4. **Bot starten** im Status-Tab
          5. **Discord:** `/setup_botmaster` um Bot-Master zu werden
          6. **GUI:** Sticky Manager fÃ¼r Message-Verwaltung
          
          Bei Problemen: Siehe **README.md** fÃ¼r vollstÃ¤ndige Anleitung!
          
          ---
          **Made with â¤ï¸ - Minimal, Sauber & Professionell!**
        draft: false
        prerelease: false
        files: |
          StickyBot-${{ github.ref_name }}.zip 